const discord = require('discord.js')
/*
‚£ø‚£ø‚£∑‚°Å‚¢Ü‚†à‚†ï‚¢ï‚¢Ç‚¢ï‚¢Ç‚¢ï‚¢Ç‚¢î‚¢Ç‚¢ï‚¢Ñ‚†Ç‚£Ç‚†Ç‚†Ü‚¢Ç‚¢ï‚¢Ç‚¢ï‚¢Ç‚¢ï‚¢Ç‚¢ï‚¢Ç  * * * * * * * * * *
‚£ø‚£ø‚£ø‚°∑‚†ä‚°¢‚°π‚£¶‚°ë‚¢Ç‚¢ï‚¢Ç‚¢ï‚¢Ç‚¢ï‚¢Ç‚†ï‚†î‚†å‚†ù‚†õ‚†∂‚†∂‚¢∂‚£¶‚£Ñ‚¢Ç‚¢ï‚¢Ç‚¢ï  
‚£ø‚£ø‚†è‚£†‚£æ‚£¶‚°ê‚¢å‚¢ø‚£∑‚£¶‚£Ö‚°ë‚†ï‚†°‚†ê‚¢ø‚†ø‚£õ‚†ü‚†õ‚†õ‚†õ‚†õ‚†°‚¢∑‚°à‚¢Ç‚¢ï‚¢Ç  Ah-ahhh!
‚†ü‚£°‚£æ‚£ø‚£ø‚£ø‚£ø‚£¶‚£ë‚†ù‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°µ‚¢Å‚£§‚£∂‚£∂‚£ø‚¢ø‚¢ø‚¢ø‚°ü‚¢ª‚£§‚¢ë‚¢Ç  S-s-senpai!
‚£æ‚£ø‚£ø‚°ø‚¢ü‚£õ‚£ª‚£ø‚£ø‚£ø‚£¶‚£¨‚£ô‚£ª‚£ø‚£ø‚£∑‚£ø‚£ø‚¢ü‚¢ù‚¢ï‚¢ï‚¢ï‚¢ï‚¢Ω‚£ø‚£ø‚£∑‚£î  T√∫ c√≥digo
‚£ø‚£ø‚†µ‚†ö‚†â‚¢Ä‚£Ä‚£Ä‚£à‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ó‚¢ï‚¢ï‚¢ï‚¢ï‚¢ï‚¢ï‚£Ω‚£ø‚£ø‚£ø‚£ø  Es demasiado grande!
‚¢∑‚£Ç‚£†‚£¥‚£æ‚°ø‚°ø‚°ª‚°ª‚£ø‚£ø‚£¥‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£µ‚£µ‚£µ‚£∑‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø  
‚¢å‚†ª‚£ø‚°ø‚°´‚°™‚°™‚°™‚°™‚£∫‚£ø‚£ø‚£ø‚£ø‚£ø‚†ø‚†ø‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†É  * * * * * * * * * * 
‚†£‚°Å‚†π‚°™‚°™‚°™‚°™‚£™‚£æ‚£ø‚£ø‚£ø‚£ø‚†ã‚†ê‚¢â‚¢ç‚¢Ñ‚¢å‚†ª‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†è‚†à
‚°£‚°ò‚¢Ñ‚†ô‚£æ‚£æ‚£æ‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°Ä‚¢ê‚¢ï‚¢ï‚¢ï‚¢ï‚¢ï‚°ò‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚†è‚††‚†à
‚†å‚¢ä‚¢Ç‚¢£‚†π‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ß‚¢ê‚¢ï‚¢ï‚¢ï‚¢ï‚¢ï‚¢Ö‚£ø‚£ø‚£ø‚£ø‚°ø‚¢ã‚¢ú‚††‚†à
‚†Ñ‚†Å‚†ï‚¢ù‚°¢‚†à‚†ª‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£∑‚£ï‚£ë‚£ë‚£ë‚£µ‚£ø‚£ø‚£ø‚°ø‚¢ã‚¢î‚¢ï‚£ø‚††‚†à
‚†®‚°Ç‚°Ä‚¢ë‚¢ï‚°Ö‚†Ç‚†Ñ‚†â‚†õ‚†ª‚†ø‚¢ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚£ø‚°ø‚¢ã‚¢î‚¢ï‚¢ï‚£ø‚£ø‚††‚†à
‚†Ñ‚†™‚£Ç‚†Å‚¢ï‚†Ü‚†Ñ‚†Ç‚†Ñ‚†Å‚°Ä‚†Ç‚°Ä‚†Ñ‚¢à‚†â‚¢ç‚¢õ‚¢õ‚¢õ‚¢ã‚¢î‚¢ï‚¢ï‚¢ï‚£Ω‚£ø‚£ø‚††‚†à
*/
class Conecta4 {

    constructor() {
        this.gameEmbed = null
    }

    iniciarJuego (msg) {

        const challenger = msg.author;
        const oppenent = msg.mentions.users.first();
        if(!oppenent) return msg.reply(`¬øCon qui√©n vas a jugar Conecta 4?`)
        if(oppenent === challenger) return msg.reply(`No puedes jugar contra contigo mism@.`)
         
        const board = [
            ["‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™"],
            ["‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™"],
            ["‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™"],
            ["‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™"],
            ["‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™"],
            ["‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™", "‚ö™"],
        ];

        const renderBoard = (board) => {
            let tempString = "";
            for (const boardSection of board) {
                tempString += `${boardSection.join("")}\n`;
            }

            tempString = tempString.concat("1Ô∏è‚É£2Ô∏è‚É£3Ô∏è‚É£4Ô∏è‚É£5Ô∏è‚É£6Ô∏è‚É£7Ô∏è‚É£");
            return tempString;
        }

        const initialState = renderBoard(board);

        const initial = new discord.MessageEmbed()
        .setAuthor(`üî¥ ${msg.author.username} es tu turno.`, msg.author.avatarURL({dynamic: true}))
        .setColor(0x21f500)
        .setTimestamp()
        .setDescription(initialState)
        .setFooter(`${challenger.username} vs ${oppenent.username}`)
        msg.channel.send(initial).then(gameMessage => {

            gameMessage.react("1Ô∏è‚É£")
            gameMessage.react("2Ô∏è‚É£")
            gameMessage.react("3Ô∏è‚É£")
            gameMessage.react("4Ô∏è‚É£")
            gameMessage.react("5Ô∏è‚É£")
            gameMessage.react("6Ô∏è‚É£")
            gameMessage.react("7Ô∏è‚É£")
    
            const gameFilter = (reaction, user) => ["1Ô∏è‚É£", "2Ô∏è‚É£", "3Ô∏è‚É£", "4Ô∏è‚É£", "5Ô∏è‚É£", "6Ô∏è‚É£", "7Ô∏è‚É£"].includes(reaction.emoji.name) && (user.id === oppenent.id || user.id === challenger.id);
    
            const gameCollector = gameMessage.createReactionCollector(gameFilter);
    
            const gameData = [
                { member: challenger, playerColor: "üî¥" },
                { member: oppenent, playerColor: "üü°"}
            ]
    
            let player = 0;
    
            const checkFour = (a, b, c, d) => (a === b) && (b === c) && (c === d) && (a !== "‚ö™");
    
            const horizontalCheck = () => {
    
                for (let i = 0; i < 6; i++) {
    
                    for (let j = 0; j < 4; j++) {
                        if(checkFour(board[i][j], board[i][j + 1], board[i][j + 2], board[i][j + 3])) return [
                            board[i][j], board[i][j + 1], board[i][j + 2], board[i][j + 3]
                        ];
                    }
                }
            }
    
            const verticalCheck = () => {
                for (let j = 0; j < 7; j++) {
                    for (let i = 0; i < 3; i++) {
    
                        if(checkFour(board[i][j], board[i + 1][j], board[i + 2][j], board[i + 3][j])) return [
                            board[i][j], board[i + 1][j], board[i + 2][j], board[i + 3][j]
                        ]
                    }
                }
            }
    
            const diagonal1 = () => {
                for (let col = 0; col < 4; col++) {
                    for (let row = 0; row < 3; row++) {
                        if(checkFour(board[row][col], board[row + 1][col + 1], board[row + 2][col + 2], board[row + 3][col + 3])) return [
                            board[row][col], board[row + 1][col + 1], board[row + 2][col + 2], board[row + 3][col + 3]
                        ]
                    }
                }
            }
    
            const diagonal2 = () => {
                for (let col = 0; col < 4; col++) {
                    for (let row = 5; row > 2; row--) {
                        if(checkFour(board[row][col], board[row - 1][col + 1], board[row - 2][col + 2], board[row - 3][col + 3])) return [
                            board[row][col], board[row - 1][col + 1], board[row - 2][col + 2], board[row - 3][col + 3]
                        ]
                    }
                }
            }
    
            const tieCheck = () => {
                let count = 0;
                for (const el of board) {
                    for (const string of el) {
                        if(string !== "‚ö™") count++;
                    }
                }
                if(count === 42) return true;
                else return false;
            }
    
            const checks = [horizontalCheck, verticalCheck, diagonal1, diagonal2];
    
            gameCollector.on("collect", (reaction, user) => {
    
                reaction.message.reactions.cache.get(reaction.emoji.name).users.remove(user.id);
    
                if(user.id === gameData[player].member.id) {
    
                    const openSpaces = [];
    
                    switch (reaction.emoji.name) {
                        case "1Ô∏è‚É£":
                            for (let i = 5; i > -1 ; i--) {
                                if(board[i][0] === "‚ö™") openSpaces.push({ i, j: 0});
                            }
                            if(openSpaces.length == 0) return msg.channel.send(`${gameData[player].member}, esa columna est√° completa, elige otra.`).then(msg1 => msg1.delete({timeout: 10000}))
                            else board[openSpaces[0].i][openSpaces[0].j] = gameData[player].playerColor;
                        break;
                        case "2Ô∏è‚É£":
                            for (let i = 5; i > -1 ; i--) {
                                if(board[i][1] === "‚ö™") openSpaces.push({ i, j: 1});
                            }
                            if(openSpaces.length == 0) return msg.channel.send(`${gameData[player].member}, esa columna est√° completa, elige otra.`).then(msg1 => msg1.delete({timeout: 10000}))
                            else board[openSpaces[0].i][openSpaces[0].j] = gameData[player].playerColor;
                        break;
                        case "3Ô∏è‚É£":
                            for (let i = 5; i > -1 ; i--) {
                                if(board[i][2] === "‚ö™") openSpaces.push({ i, j: 2});
                            }
                            if(openSpaces.length == 0) return msg.channel.send(`${gameData[player].member}, esa columna est√° completa, elige otra.`).then(msg1 => msg1.delete({timeout: 10000}))
                            else board[openSpaces[0].i][openSpaces[0].j] = gameData[player].playerColor;
                        break;
                        case "4Ô∏è‚É£":
                            for (let i = 5; i > -1 ; i--) {
                                if(board[i][3] === "‚ö™") openSpaces.push({ i, j: 3});
                            }
                            if(openSpaces.length == 0) return msg.channel.send(`${gameData[player].member}, esa columna est√° completa, elige otra.`).then(msg1 => msg1.delete({timeout: 10000}))
                            else board[openSpaces[0].i][openSpaces[0].j] = gameData[player].playerColor;
                        break;
                        case "5Ô∏è‚É£":
                            for (let i = 5; i > -1 ; i--) {
                                if(board[i][4] === "‚ö™") openSpaces.push({ i, j: 4});
                            }
                            if(openSpaces.length == 0) return msg.channel.send(`${gameData[player].member}, esa columna est√° completa, elige otra.`).then(msg1 => msg1.delete({timeout: 10000}))
                            else board[openSpaces[0].i][openSpaces[0].j] = gameData[player].playerColor;
                        break;
                        case "6Ô∏è‚É£":
                            for (let i = 5; i > -1 ; i--) {
                                if(board[i][5] === "‚ö™") openSpaces.push({ i, j: 5});
                            }
                            if(openSpaces.length == 0) return msg.channel.send(`${gameData[player].member}, esa columna est√° completa, elige otra.`).then(msg1 => msg1.delete({timeout: 10000}))
                            else board[openSpaces[0].i][openSpaces[0].j] = gameData[player].playerColor;
                        break;
                        case "7Ô∏è‚É£":
                            for (let i = 5; i > -1 ; i--) {
                                if(board[i][6] === "‚ö™") openSpaces.push({ i, j: 6});
                            }
                            if(openSpaces.length == 0) return msg.channel.send(`${gameData[player].member}, esa columna est√° completa, elige otra.`).then(msg1 => msg1.delete({timeout: 10000}))
                            else board[openSpaces[0].i][openSpaces[0].j] = gameData[player].playerColor;
                        break;
                    }
    
                    if(tieCheck()) {
                        gameMessage.reactions.removeAll()
                        const TieEmbed = new discord.MessageEmbed()
                        .setAuthor(`Juego finalizado. ¬°Es un empate!`, msg.guild.iconURL({dynamic: true}))
                        .setColor(0xf1f500)
                        .setTimestamp()
                        .setDescription(renderBoard(board))
                        .setFooter(`${challenger.username} vs ${oppenent.username}`)
                        gameCollector.stop("Tie Game")
                        return gameMessage.edit(TieEmbed)
                    }
    
                    for (const func of checks) {
    
                        const data = func();
                        if(data) {
                            gameMessage.reactions.removeAll()
    
                            const WinEmbed = new discord.MessageEmbed()
                            .setAuthor(`¬°${gameData[player].member.username} ha ganado el juego, felicidades!`)
                            .setThumbnail(gameData[player].member.avatarURL({size: 1024, dynamic: true}))
                            .setColor(0x21f500)
                            .setDescription(renderBoard(board))
                            .setTimestamp()
                            .setFooter(`${challenger.username} vs ${oppenent.username}`)
                            gameCollector.stop(`${gameData[player].member.id} won`);
                            return gameMessage.edit(WinEmbed)
                        }
                    }
    
                    player = (player + 1) % 2;
    
                    const newEmbed = new discord.MessageEmbed()
                    .setAuthor(`${gameData[player].playerColor} ${gameData[player].member.username} es tu turno.`, gameData[player].member.avatarURL({dynamic: true}))
                    .setColor(0x0549f5)
                    .setDescription(renderBoard(board))
                    .setTimestamp()
                    .setFooter(`${challenger.username} vs ${oppenent.username}`)
                    gameMessage.edit("", { embed: newEmbed});
                }
            })
        })

    }
}

module.exports = Conecta4;